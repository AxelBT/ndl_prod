<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Matrix Audio Visualizer - Dancing Effect</title>
<style>
    body { margin:0; overflow:hidden; background:#000; }
    canvas { display:block; }
    #controls {
        position:absolute;
        bottom:20px;
        left:50%;
        transform:translateX(-50%);
        z-index:20;
    }
    button, input[type="file"] {
        color:#0f0;
        background:#000;
        border:1px solid #0f0;
        padding:5px 10px;
        margin:0 5px;
        cursor:pointer;
    }
</style>
</head>
<body>

<canvas id="matrix"></canvas>

<div id="controls">
    <input type="file" id="audioFile" accept="audio/*">
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>
    <button id="stopBtn">Stop</button>
</div>

<script>
const canvas = document.getElementById('matrix');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const fontSize = 18;
let columns = Math.floor(canvas.width / fontSize);
let drops = [];
let waveOffsets = [];

const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()*&^%';

function initDrops() {
    drops = Array(columns).fill(1);
    waveOffsets = Array.from({length: columns}, (_, i) => Math.random() * Math.PI * 2);
}
initDrops();

let audioCtx, analyser, source;
let animationId;
let currentAudio = null;
let isPaused = false;

const audioFileInput = document.getElementById('audioFile');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');

// Load new audio file
audioFileInput.onchange = function() {
    const file = this.files[0];
    if(!file) return;

    if(animationId) cancelAnimationFrame(animationId);
    if(currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }

    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    initDrops();

    const audio = new Audio(URL.createObjectURL(file));
    audio.play();
    currentAudio = audio;
    isPaused = false;

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;

    source = audioCtx.createMediaElementSource(audio);
    source.connect(analyser);
    source.connect(audioCtx.destination);

    animate();
}

playBtn.onclick = function() {
    if(currentAudio && isPaused) {
        currentAudio.play();
        isPaused = false;
        animate();
    }
}

pauseBtn.onclick = function() {
    if(currentAudio && !isPaused) {
        currentAudio.pause();
        isPaused = true;
        if(animationId) cancelAnimationFrame(animationId);
    }
}

stopBtn.onclick = function() {
    if(currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
        isPaused = false;
    }
    if(animationId) cancelAnimationFrame(animationId);

    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    initDrops();
}

function animate() {
    if(isPaused) return;

    animationId = requestAnimationFrame(animate);
    if(!analyser) return;

    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(dataArray);

    ctx.fillStyle = 'rgba(0,0,0,0.05)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.font = `${fontSize}px monospace`;

    for(let i=0; i<drops.length; i++) {
        const freqValue = dataArray[i % bufferLength];
        const brightness = Math.min(1, freqValue / 200);

        let x = i * fontSize;
        let y = drops[i] * fontSize;

        // --- Dancing horizontal wave ---
        const wave = Math.sin(Date.now() * 0.002 + waveOffsets[i]) * 10;
        x += wave; // horizontal movement

        const char = letters[Math.floor(Math.random()*letters.length)];

        if(drops[i] <= 1) {
            ctx.fillStyle = "rgba(255,255,200,1)";
        } else if(drops[i] <= 3) {
            ctx.fillStyle = "rgba(180,255,180,0.9)";
        } else {
            const fadeFactor = Math.max(0.2, 1 - drops[i] * 0.015);
            ctx.fillStyle = `rgba(0,255,0,${fadeFactor})`;
        }

        ctx.fillText(char, x, y);

        // --- Add dancing vertical wobble ---
        const wobble = Math.sin(Date.now() * 0.004 + i) * 0.3;
        drops[i] += (1 + brightness * 15) * 0.13 + wobble;

        if (drops[i] * fontSize > canvas.height) drops[i] = 1;
    }
}

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    columns = Math.floor(canvas.width / fontSize);
    initDrops();
});
// DIO Easter Egg audio
const dioAudio = new Audio("../../audio/theworld.mp3");
dioAudio.volume = 0.8; // adjust as needed
document.getElementById('pauseBtn').onclick = function() {
     if(currentAudio && !isPaused) {
        // Pause current audio
        currentAudio.pause();
        isPaused = true;

        // Stop normal animation
        if(animationId) cancelAnimationFrame(animationId);

        // --- DIO Easter Egg ---
        dioAudio.currentTime = 0; // restart DIO audio
        dioAudio.play();

        // --- Screen Flash on canvas ---
        ctx.fillStyle = 'rgba(135,165,238,255)'; // red flash
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // --- Time Stop Matrix Effect ---
        const timeStopDuration = 2000; // ms
        const slowFactor = 0.02; // slows drops to nearly zero

        let start = Date.now();

        function timeStopAnimate() {
            const elapsed = Date.now() - start;
            if(elapsed > timeStopDuration) {
                // Resume normal animation
                animate();
                return;
            }

            // Draw frozen / slowed letters with semi-transparent overlay
            ctx.fillStyle = 'rgba(0,0,0,0.05)'; // slight trail fade
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.font = `${fontSize}px monospace`;
            for(let i = 0; i < drops.length; i++) {
                const char = letters[Math.floor(Math.random() * letters.length)];

                let x = i * fontSize;
                let y = drops[i] * fontSize;

                 // Change letters to purple for the first half of time-stop
                if(elapsed < timeStopDuration / 2){
                    ctx.fillStyle = `rgba(128,0,128,0.8)`; // purple
                } else {
                    ctx.fillStyle = `rgba(0,255,0,0.8)`; // back to green
                }
                ctx.fillText(char, x, y);

                // Move drops very slowly to simulate time stop
                drops[i] += slowFactor;
            }

            requestAnimationFrame(timeStopAnimate);
        }

        timeStopAnimate();
    }
}


</script>

</body>
</html>
